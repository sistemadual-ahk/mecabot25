<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Robot con Activación por Voz</title>
  <style>
    body {
      background: #0a0a0a;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      color: white;
      font-family: sans-serif;
    }

    video { display: none; }

    .cara {
      width: 300px;
      height: 300px;
      background: #111;
      border-radius: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 40px rgba(255, 200, 0, 0.6);
      position: relative;
      overflow: hidden;
      margin-bottom: 20px;
      transition: box-shadow 0.3s ease;
    }

    .cara.activa {
      box-shadow: 0 0 50px rgba(0, 255, 100, 0.8);
    }

    .ojos {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      margin-top: 40px;
    }

    .ojo-contenedor {
      position: relative;
      width: 60px;
      height: 60px;
      margin: 0 30px;
    }

    .ojo {
      width: 60px;
      height: 60px;
      background: orange;
      border-radius: 50%;
      transition: transform 0.15s linear, height 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .ojo.cerrado {
      height: 10px;
      background: transparent;
      border-bottom: 8px solid orange;
      border-radius: 0;
    }

    .ceja {
      width: 50px;
      height: 10px;
      background: orange;
      border-radius: 5px;
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      transition: transform 0.2s ease-out, rotate 0.2s ease-out;
    }

    .boca-contenedor {
      margin-top: 50px;
      transition: transform 0.1s linear;
    }

    .boca {
      width: 120px;
      height: 10px;
      border-bottom: 10px solid orange;
      border-radius: 0;
      transition: all 0.3s ease-in-out;
    }

    .neutral { border-bottom: 10px solid orange; height: 10px; }
    .feliz { border-radius: 0 0 60px 60px; border-bottom: 10px solid orange; height: 40px; }
    .sorprendido { width: 60px; height: 60px; border-radius: 50%; border: 10px solid orange; border-bottom: none; }
    .triste { border-radius: 0 0 40px 40px; border-bottom: 10px solid orange; transform: rotate(180deg); }
    .enojado { border-radius: 0; border-bottom: 10px solid orange; transform: rotate(180deg) scaleX(1.2); }

    #estadoVoz {
      font-size: 18px;
      margin-top: 10px;
      color: #ffcc00;
    }

    #estadoMovimiento {
      font-size: 16px;
      margin-top: 8px;
      color: #00ffff;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline muted></video>

  <div class="cara" id="cara">
    <div class="ojos">
      <div class="ojo-contenedor">
        <div class="ceja" id="ceja-izq"></div>
        <div class="ojo" id="ojo-izq"></div>
      </div>
      <div class="ojo-contenedor">
        <div class="ceja" id="ceja-der"></div>
        <div class="ojo" id="ojo-der"></div>
      </div>
    </div>

    <div class="boca-contenedor" id="bocaContenedor">
      <div class="boca neutral" id="boca"></div>
    </div>
  </div>

  <div id="estadoVoz">🎤 Diga "robot" para activar</div>
  <div id="estadoMovimiento">📡 Esperando movimiento...</div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
const WEBHOOK_URL = "http://localhost:5678/webhook-test/e53a29fb-cbc6-4f27-84dd-419ddf0df0cb";

const videoElement = document.getElementById('video');
const ojoIzq = document.getElementById('ojo-izq');
const ojoDer = document.getElementById('ojo-der');
const boca = document.getElementById('boca');
const bocaContenedor = document.getElementById('bocaContenedor');
const cejaIzq = document.getElementById('ceja-izq');
const cejaDer = document.getElementById('ceja-der');
const estadoVoz = document.getElementById('estadoVoz');
const estadoMovimiento = document.getElementById('estadoMovimiento');
const cara = document.getElementById('cara');

let reconocimientoActivo = false;
let suavizadoOjoX = 0, suavizadoOjoY = 0;

// === Control del envío al webhook ===
let ultimaDireccion = "";
let ultimoEnvio = 0;
const TIEMPO_ENTRE_ENVIOS = 800; // ms

async function enviarMovimiento(direccion) {
  const ahora = Date.now();
  if (direccion !== ultimaDireccion || (ahora - ultimoEnvio) > TIEMPO_ENTRE_ENVIOS) {
    ultimaDireccion = direccion;
    ultimoEnvio = ahora;

    const data = { movimiento: direccion, timestamp: ahora };
    estadoMovimiento.textContent = `➡️ Movimiento detectado: ${direccion.toUpperCase()} | Enviando a n8n: ${JSON.stringify(data)}`;
    console.log("📤 Enviando:", data);

    try {
      await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
    } catch (e) {
      console.warn("Error enviando al webhook:", e);
      estadoMovimiento.textContent = `⚠️ Error al enviar a n8n (${direccion})`;
    }
  }
}

const faceMesh = new FaceMesh({ locateFile: (file) =>
  `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
});
faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

// === Parpadeo natural ===
function parpadear() {
  if (!reconocimientoActivo) return;
  ojoIzq.classList.add('cerrado');
  ojoDer.classList.add('cerrado');
  setTimeout(() => {
    ojoIzq.classList.remove('cerrado');
    ojoDer.classList.remove('cerrado');
  }, 250);
  const delay = Math.random() * 3000 + 3000;
  setTimeout(parpadear, delay);
}

// === Procesamiento facial ===
faceMesh.onResults((results) => {
  if (!reconocimientoActivo) return;
  if (!results.multiFaceLandmarks?.length) return;

  const landmarks = results.multiFaceLandmarks[0];
  const leftEye = landmarks[468];
  const rightEye = landmarks[473];
  const avgX = (leftEye.x + rightEye.x) / 2;
  const avgY = (leftEye.y + rightEye.y) / 2;

  const targetX = (0.5 - avgX) * 800;
  const targetY = (avgY - 0.5) * 800;

  suavizadoOjoX += (targetX - suavizadoOjoX) * 0.2;
  suavizadoOjoY += (targetY - suavizadoOjoY) * 0.2;

  const limX = Math.max(-40, Math.min(40, suavizadoOjoX));
  const limY = Math.max(-25, Math.min(25, suavizadoOjoY));

  ojoIzq.style.transform = `translate(${limX}px, ${limY}px)`;
  ojoDer.style.transform = `translate(${limX}px, ${limY}px)`;
  bocaContenedor.style.transform = `translate(${limX * 0.5}px, ${limY * 0.5}px)`;

  // === Detectar movimiento de cabeza ===
  if (Math.abs(limX) > Math.abs(limY)) {
    if (limX > 20) enviarMovimiento("derecha");
    else if (limX < -20) enviarMovimiento("izquierda");
  } else {
    if (limY > 15) enviarMovimiento("abajo");
    else if (limY < -15) enviarMovimiento("arriba");
  }

   // === Expresiones ===
const eyeDistance = Math.abs(landmarks[263].x - landmarks[33].x);
const mouthOpen = Math.abs(landmarks[14].y - landmarks[13].y) / eyeDistance;
const mouthWidth = Math.abs(landmarks[291].x - landmarks[61].x) / eyeDistance;

// Cejas y ojos
const cejaIzqY = (landmarks[70].y + landmarks[105].y) / 2;
const cejaDerY = (landmarks[336].y + landmarks[334].y) / 2;
const ojoIzqY = (landmarks[159].y + landmarks[145].y) / 2;
const ojoDerY = (landmarks[386].y + landmarks[374].y) / 2;
const cejaAlturaPromedio = ((cejaIzqY - ojoIzqY) + (cejaDerY - ojoDerY)) / 2;

// Calcular si la cara está centrada
const desviacionX = Math.abs(limX);
const desviacionY = Math.abs(limY);
const caraCentrada = desviacionX < 15 && desviacionY < 15; // umbral de centrado

boca.className = "boca neutral";
let expresion = "neutral";

// Felicidad o sorpresa (se mantienen)
if (mouthOpen > 0.30) expresion = "sorprendido";
else if (mouthWidth > 0.65 && mouthOpen < 0.25) expresion = "feliz";

// 😠 NUEVA condición: cara centrada + cejas bajas = enojado
else if (caraCentrada && cejaAlturaPromedio < 0.03) expresion = "enojado";

boca.classList.add(expresion);

let cejaY = -25, rotIzq = 0, rotDer = 0;
if (expresion === "feliz") cejaY -= 10;
if (expresion === "sorprendido") cejaY -= 15;
if (expresion === "enojado") { cejaY += 8; rotIzq = 25; rotDer = -25; }

cejaIzq.style.transform = `translate(${limX - 20}px, ${limY + cejaY}px) rotate(${rotIzq}deg)`;
cejaDer.style.transform = `translate(${limX - 20}px, ${limY + cejaY}px) rotate(${rotDer}deg)`;


});

const camera = new Camera(videoElement, {
  onFrame: async () => { await faceMesh.send({ image: videoElement }); },
  width: 640,
  height: 480
});
camera.start();

// === Activación por voz ===
if ('webkitSpeechRecognition' in window) {
  const recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.lang = 'es-ES';

  recognition.onresult = (event) => {
    const texto = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
    console.log('Reconocido:', texto);

    if (texto.includes('robot') && !reconocimientoActivo) {
      reconocimientoActivo = true;
      estadoVoz.textContent = '🤖 Activado';
      estadoMovimiento.textContent = '📡 Esperando movimiento...';
      cara.classList.add('activa');
      parpadear();
    } 
    else if ((texto.includes('adiós') || texto.includes('adios')) && reconocimientoActivo) {
      reconocimientoActivo = false;
      estadoVoz.textContent = '🛑 Desactivado (diga "robot" para reactivar)';
      estadoMovimiento.textContent = '⏸️ Movimientos pausados';
      cara.classList.remove('activa');
    }
  };

  recognition.onerror = (e) => console.error('Error:', e);
  recognition.onend = () => recognition.start();
  recognition.start();
} else {
  estadoVoz.textContent = '⚠️ Tu navegador no soporta reconocimiento de voz';
}
</script>
</body>
</html>
