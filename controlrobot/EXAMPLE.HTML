<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Robot con Activación por Voz</title>
  <style>
    body {
      background: #0a0a0a;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      color: rgb(255, 255, 255);
      font-family: sans-serif;
    }

    video { 
      display: none; 
    }

    .cara {
      width: 80vw;
      height: calc(80vw * 10.5 / 17);
      background: #111;
      border-radius: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 40px rgba(0, 255, 247, 0.6);
      position: relative;
      overflow: hidden;
      margin-bottom: 20px;
      transition: box-shadow 0.3s ease;
    }

    .cara.activa {
      box-shadow: 0 0 50px rgba(0, 255, 255, 0.8);
    }

    .ojos {
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      width: 80%;
      margin-top: 40px;
    }

    .ojo-contenedor {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .ojo {
      width: 120px;
      height: 120px;
      background: rgb(0, 183, 255);
      border-radius: 50%;
      transition: transform 0.15s linear, height 0.15s ease;
      position: relative;
      overflow: hidden;
    }

    .ojo.cerrado {
      height: 10px;
      background: transparent;
      border-bottom: 8px solid rgb(0, 221, 255);
      border-radius: 0;
    }

    .ceja {
      width: 130px;
      height: 10px;
      background: rgb(0, 221, 255);
      border-radius: 5px;
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      transition: transform 0.2s ease-out, rotate 0.2s ease-out;
    }

    .boca-contenedor {
      margin-top: 90px;
      transition: transform 0.1s linear;
    }

    .boca {
      width: 200px;
      height: 12px;
      border-bottom: 10px solid rgb(0, 255, 255);
      border-radius: 0;
      transition: all 0.3s ease-in-out;
    }

    .neutral { 
      border-bottom: 10px solid rgb(0, 229, 255); 
      height: 12px; 
    }

    .feliz { 
      border-radius: 0 0 100px 100px;
      border-bottom: 12px solid rgb(0, 255, 217);
      height: 100px;
      width: 300px;
    }

    .sorprendido { 
      width: 120px; 
      height: 120px; 
      border-radius: 80%; 
      border: 10px solid rgb(0, 208, 255); 
      border-bottom: none; 
    }

    #estadoVoz {
      font-size: 18px;
      margin-top: 10px;
      color: #00eaff;
    }

    #estadoMovimiento {
      font-size: 16px;
      margin-top: 8px;
      color: #00ffff;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline muted></video>

  <div class="cara" id="cara">
    <div class="ojos">
      <div class="ojo-contenedor">
        <div class="ceja" id="ceja-izq"></div>
        <div class="ojo" id="ojo-izq"></div>
      </div>
      <div class="ojo-contenedor">
        <div class="ceja" id="ceja-der"></div>
        <div class="ojo" id="ojo-der"></div>
      </div>
    </div>
    <div class="boca-contenedor" id="bocaContenedor">
      <div class="boca neutral" id="boca"></div>
    </div>
  </div>

  <div id="estadoVoz">🎤 Diga "robot" para activar</div>
  <div id="estadoMovimiento">📡 Esperando movimiento...</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script>
  const WEBHOOK_URL_NODE = "http://127.0.0.1:1880/comando";
  const WEBHOOK_URL_N8N = "http://localhost:5678/webhook-test/4b68e260-2817-4c8f-b3eb-e332e32ddfed";

  const videoElement = document.getElementById('video');
  const ojoIzq = document.getElementById('ojo-izq');
  const ojoDer = document.getElementById('ojo-der');
  const boca = document.getElementById('boca');
  const bocaContenedor = document.getElementById('bocaContenedor');
  const cejaIzq = document.getElementById('ceja-izq');
  const cejaDer = document.getElementById('ceja-der');
  const estadoVoz = document.getElementById('estadoVoz');
  const estadoMovimiento = document.getElementById('estadoMovimiento');
  const cara = document.getElementById('cara');

  let reconocimientoActivo = false;
  let hablando = false; // Flag para animación de boca
  let suavizadoOjoX = 0, suavizadoOjoY = 0;
  let parpadeoIntervalo = null;

  // --- Control de envío de movimiento ---
  let movimientoPendiente = null;
  let debounceTimer = null;
  function enviarMovimientoDebounced(direccion) {
    movimientoPendiente = direccion;
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      enviarMovimiento(movimientoPendiente);
      movimientoPendiente = null;
    }, 800);
  }

  async function enviarMovimiento(direccion) {
    const data = { movimiento: direccion, timestamp: Date.now() };
    estadoMovimiento.textContent = `➡️ Movimiento detectado: ${direccion.toUpperCase()}`;
    try {
      await fetch(WEBHOOK_URL_NODE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
    } catch (e) {
      console.warn("Error enviando al webhook:", e);
      estadoMovimiento.textContent = `⚠️ Error al enviar a Node-RED (${direccion})`;
    }
  }

  // --- Configuración de FaceMesh ---
  const faceMesh = new FaceMesh({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
  });
  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  // --- Animaciones aleatorias cuando está en reposo ---
  function parpadearAmbos() {
    ojoIzq.classList.add('cerrado');
    ojoDer.classList.add('cerrado');
    setTimeout(() => {
      ojoIzq.classList.remove('cerrado');
      ojoDer.classList.remove('cerrado');
    }, 200);
  }
  function parpadearOjo(ojo) {
    ojo.classList.add('cerrado');
    setTimeout(() => ojo.classList.remove('cerrado'), 200);
  }

  const expresionesAleatorias = ['neutral', 'feliz', 'sorprendido'];

  function mostrarCaraAleatoria() {
    if (reconocimientoActivo) return;

    const expresion = expresionesAleatorias[Math.floor(Math.random() * expresionesAleatorias.length)];
    boca.className = 'boca ' + expresion;

    const bocaEscalaX = 0.8 + Math.random() * 0.4;
    const bocaEscalaY = 0.8 + Math.random() * 0.4;
    boca.style.transform = `scaleX(${bocaEscalaX}) scaleY(${bocaEscalaY})`;

    const ojoEscalaIzq = 0.8 + Math.random() * 0.4;
    const ojoEscalaDer = 0.8 + Math.random() * 0.4;
    const eyeOffsetX = (Math.random() - 0.5) * 10;
    const eyeOffsetY = (Math.random() - 0.5) * 10;
    ojoIzq.style.transform = `scale(${ojoEscalaIzq}) translate(${eyeOffsetX}px, ${eyeOffsetY}px)`;
    ojoDer.style.transform = `scale(${ojoEscalaDer}) translate(${eyeOffsetX}px, ${eyeOffsetY}px)`;

    const margenEncimaOjo = 25;
    let baseCejaY = -25;
    if (expresion === "feliz") baseCejaY -= 10;
    if (expresion === "sorprendido") baseCejaY -= 15;
    const cejaY = baseCejaY - margenEncimaOjo;

    const rotIzq = (Math.random() - 0.5) * 20;
    const rotDer = (Math.random() - 0.5) * 20;
    cejaIzq.style.transform = `translate(-50%, ${cejaY}px) rotate(${rotIzq}deg)`;
    cejaDer.style.transform = `translate(-50%, ${cejaY}px) rotate(${rotDer}deg)`;

    if (Math.random() < 0.5) parpadearAmbos();
  }

  function iniciarCarasAleatorias() {
    if (parpadeoIntervalo) clearInterval(parpadeoIntervalo);
    parpadeoIntervalo = setInterval(() => {
      mostrarCaraAleatoria();
    }, 2000 + Math.random() * 2000);
  }
  iniciarCarasAleatorias();

  // --- Control de movimientos físicos ---
  let ultimaDireccion = null;
  let ultimoEnvio = 0;

  function controlarMovimiento(direccion) {
    if (direccion !== ultimaDireccion) {
      enviarMovimiento(direccion);
      ultimaDireccion = direccion;
    }
  }

  // --- 💤 Reposo automático ---
  let tiempoUltimaCara = Date.now();
  const TIEMPO_SIN_CARA = 1000; // ms

  setInterval(() => {
    const ahora = Date.now();
    if (ahora - tiempoUltimaCara > TIEMPO_SIN_CARA) {
      if (ultimaDireccion !== "stop") {
        enviarMovimiento("stop");
        ultimaDireccion = "stop";
      }
      cara.style.transition = "transform 0.6s ease";
      ojoIzq.style.transform = "translate(0, 0)";
      ojoDer.style.transform = "translate(0, 0)";
      bocaContenedor.style.transform = "translate(0, 0)";
      cejaIzq.style.transform = "translate(-50%, -25px) rotate(0deg)";
      cejaDer.style.transform = "translate(-50%, -25px) rotate(0deg)";
      setTimeout(() => (cara.style.transition = ""), 600);
    }
  }, 200);

  // --- Procesamiento de FaceMesh ---
  faceMesh.onResults((results) => {
    if (results.multiFaceLandmarks?.length) tiempoUltimaCara = Date.now();
    else return;

    const landmarks = results.multiFaceLandmarks[0];
    const leftEye = landmarks[468];
    const rightEye = landmarks[473];
    const avgX = (leftEye.x + rightEye.x) / 2;
    const avgY = (leftEye.y + rightEye.y) / 2;

    const targetX = (0.5 - avgX) * 800;
    const targetY = (avgY - 0.5) * 800;
    suavizadoOjoX += (targetX - suavizadoOjoX) * 0.2;
    suavizadoOjoY += (targetY - suavizadoOjoY) * 0.2;

    const caraRect = cara.getBoundingClientRect();
    const maxX = caraRect.width * 0.133;
    const maxY = caraRect.height * 0.083;
    const limX = Math.max(-maxX, Math.min(maxX, suavizadoOjoX));
    const limY = Math.max(-maxY, Math.min(maxY, suavizadoOjoY));

    if (!reconocimientoActivo) return;

    const leftEAR = Math.abs(landmarks[159].y - landmarks[145].y);
    const rightEAR = Math.abs(landmarks[386].y - landmarks[374].y);
    const umbralParpadeo = 0.005;
    if (leftEAR < umbralParpadeo && !ojoDer.classList.contains('cerrado')) parpadearOjo(ojoDer);
    if (rightEAR < umbralParpadeo && !ojoIzq.classList.contains('cerrado')) parpadearOjo(ojoIzq);

    ojoIzq.style.transform = `translate(${limX}px, ${limY}px)`;
    ojoDer.style.transform = `translate(${limX}px, ${limY}px)`;
    bocaContenedor.style.transform = `translate(${limX * 0.5}px, ${limY * 0.5}px)`;

    const umbralX = caraRect.width * 0.05;
    const umbralY = caraRect.height * 0.05;
    let direccion = null;

    if (Math.abs(limX) > Math.abs(limY)) {
      if (limX > umbralX) direccion = "derecha";
      else if (limX < -umbralX) direccion = "izquierda";
    } else {
      if (limY > umbralY) direccion = "abajo";
      else if (limY < -umbralY) direccion = "arriba";
    }
    if (!direccion) direccion = "centro";
    controlarMovimiento(direccion);

    // --- Expresiones de boca solo si no habla ---
    if (!hablando) {
      const eyeDistance = Math.abs(landmarks[263].x - landmarks[33].x);
      const mouthOpen = Math.abs(landmarks[14].y - landmarks[13].y) / eyeDistance;
      const mouthWidth = Math.abs(landmarks[291].x - landmarks[61].x) / eyeDistance;

      boca.className = "boca neutral";
      let expresion = "neutral";
      if (mouthOpen > 0.30) expresion = "sorprendido";
      else if (mouthWidth > 0.65 && mouthOpen < 0.25) expresion = "feliz";
      boca.classList.add(expresion);

      let cejaY = -25, rotIzq = 0, rotDer = 0;
      if (expresion === "feliz") cejaY -= 10;
      if (expresion === "sorprendido") cejaY -= 15;
      cejaIzq.style.transform = `translate(${limX - 75}px, ${limY + cejaY}px) rotate(${rotIzq}deg)`;
      cejaDer.style.transform = `translate(${limX - 50}px, ${limY + cejaY}px) rotate(${rotDer}deg)`;
    }
  });

  // --- Cámara ---
  const camera = new Camera(videoElement, {
    onFrame: async () => { await faceMesh.send({ image: videoElement }); },
    width: 640,
    height: 480
  });
  camera.start();

  // --- Funciones de voz ---
  function hablar(texto) {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(texto);
      utterance.lang = 'es-ES';
      utterance.rate = 1;
      utterance.pitch = 1;
      animarBocaMientrasHabla(utterance);
      window.speechSynthesis.speak(utterance);
    } else console.warn("Tu navegador no soporta SpeechSynthesis");
  }

  function animarBocaMientrasHabla(utterance) {
    let animInterval = null;
    utterance.onstart = () => {
      hablando = true;
      boca.classList.add('feliz');
      let abrir = false;
      animInterval = setInterval(() => {
        abrir = !abrir;
        boca.style.transform = abrir ? 'scaleY(1.5) scaleX(1.3)' : 'scaleY(1) scaleX(1.3)';
      }, 200);
    };
    utterance.onend = () => {
      clearInterval(animInterval);
      hablando = false;
      boca.style.transform = 'scaleY(1) scaleX(1)';
      boca.classList.remove('feliz');
    };
  }

  // --- Reconocimiento de voz ---
  if ('webkitSpeechRecognition' in window) {
    const recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.lang = 'es-ES';

    recognition.onresult = (event) => {
      const texto = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
      if (texto.includes('robot') && !reconocimientoActivo) {
        reconocimientoActivo = true;
        estadoVoz.textContent = '🤖 Activado';
        estadoMovimiento.textContent = '📡 Esperando movimiento...';
        cara.classList.add('activar');
        hablar("¡Hola Bienvenido, Me presento, mi nombre es Che Robot, nací en el año 2025 para ser el robot de la AHK.");
      } else if ((texto.includes('adiós') || texto.includes('adios')) && reconocimientoActivo) {
        reconocimientoActivo = false;
        estadoVoz.textContent = '🛑 Desactivado (diga "robot" para reactivar)';
        estadoMovimiento.textContent = '⏸️ Movimientos pausados';
        cara.classList.remove('activa');
      } else if (texto.includes('mecatrónica')) {
        grabarYEnviarAudio();
      }
    };

    recognition.onerror = (e) => console.error('Error:', e);
    recognition.onend = () => recognition.start();
    recognition.start();
  } else {
    estadoVoz.textContent = '🎤 Usando reconocimiento offline (Vosk.js)';
  }

  async function grabarYEnviarAudio() {
    estadoVoz.textContent = "🎙 Grabando audio…";
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      const chunks = [];
      mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(chunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append('audio', audioBlob, 'grabacion.webm');

        estadoVoz.textContent = '✨ Enviando audio...';
        boca.className = 'boca feliz'; 

        try {
          const response = await fetch(WEBHOOK_URL_N8N, { method: 'POST', body: formData });
          estadoVoz.textContent = response.ok ? '✅ Audio enviado' : '❌ Error al enviar el audio';
        } catch (error) {
            console.error('Error en la solicitud fetch:', error);
            estadoVoz.textContent = '❌ Error de conexión';
        } finally {
            setTimeout(() => {
                estadoVoz.textContent = '🤖 Activado';
                boca.className = 'boca neutral';
            }, 2000); 
        }
      };
      mediaRecorder.start();
      setTimeout(() => mediaRecorder.stop(), 5000);
    } catch (error) {
      console.error("Error al grabar:", error);
      estadoVoz.textContent = "⚠️ No se pudo grabar audio";
    }
  }
</script>
</body>
</html>
